# Ensure required modules: mod_rewrite, mod_expires, mod_headers, mod_deflate

<IfModule mod_deflate.c>
  # Compress HTML, CSS, JavaScript, Text, XML and fonts
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
  AddOutputFilterByType DEFLATE application/javascript application/x-javascript
  AddOutputFilterByType DEFLATE application/json application/xml application/rss+xml application/atom+xml
  AddOutputFilterByType DEFLATE application/xhtml+xml application/xml+rss
  AddOutputFilterByType DEFLATE application/font-woff application/font-woff2
  AddOutputFilterByType DEFLATE font/ttf font/otf
  AddOutputFilterByType DEFLATE image/svg+xml

  # Don't try to compress already compressed formats
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|avif|ico)$ no-gzip dont-vary

  # Ensure proxies/cache vary by Accept-Encoding
  <IfModule mod_headers.c>
    Header append Vary Accept-Encoding
  </IfModule>

  # Workarounds for buggy browsers (optional but safe)
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip
</IfModule>

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 1 month"

  # Images
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"

  # Fonts
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"

  # CSS / JS
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/x-javascript "access plus 1 year"

  # HTML: short TTL so updates propagate
  ExpiresByType text/html "access plus 10 minutes"
</IfModule>

<IfModule mod_headers.c>
  # Long-lived immutable cache for fingerprinted static files
  <FilesMatch "\.(?:js|css|png|jpg|jpeg|gif|webp|avif|svg|ico|woff2|woff|ttf|otf)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Short cache for index.html so changes deploy quickly
  <FilesMatch "^index\.html$">
    Header set Cache-Control "public, max-age=600, must-revalidate"
  </FilesMatch>

  # API endpoints: no-cache (use SetEnvIf since Location/LocationMatch are not allowed in .htaccess)
  SetEnvIf Request_URI "^/api/" IS_API=1
  Header set Cache-Control "no-cache, must-revalidate, max-age=0" env=IS_API

  # Allow cross-origin font access for browsers (needed when previewing from another origin)
  <FilesMatch "\.(?:ttf|otf|eot|woff|woff2)$">
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, OPTIONS"
    Header set Access-Control-Allow-Headers "Origin, Accept, Content-Type"
  </FilesMatch>
</IfModule>

<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # Allow direct access to existing files and directories
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # Allow Next asset folder and common static folders through
  RewriteRule ^_next/ - [L]
  RewriteRule ^static/ - [L]
  RewriteRule ^assets/ - [L]
  RewriteRule ^favicon.ico$ - [L]
  RewriteRule ^robots.txt$ - [L]
  RewriteRule ^sitemap.xml$ - [L]

  # Serve prerendered HTML for known bot user-agents when available
  RewriteCond %{HTTP_USER_AGENT} "(googlebot|bingbot|yahoo|baiduspider|facebookexternalhit|twitterbot|linkedinbot|slackbot|applebot|petalbot)" [NC]
  RewriteCond %{DOCUMENT_ROOT}/prerender%{REQUEST_URI}/index.html -f
  RewriteRule ^(.*)$ /prerender%{REQUEST_URI}/index.html [L]

  # If using a static export (next export) fall back to index.html for client-side routes
  # (This enables page refresh on dynamic routes for static hosting.)
  RewriteRule ^ /index.html [L]
</IfModule>